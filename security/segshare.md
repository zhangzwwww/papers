# SeGShare: Secure Group File Sharing in the Cloud using Enclaves

## Introduction

## Design

### 建立用户和 enclave 之间的信任
k
建立用户和云提供商的 enclave 建立双边信任，这个过程只执行一次。

#### Establish user trust in enclave

CA 的公钥被硬编码到 enclave。 在认证的过程中，CA 建立了一个安全通道，这个通道要来做下列信息交换：

1. CA 证书签名请求
2. enclave 生成一个临时的密钥对，并想CA提供包含该临时密钥对中的公钥的签名请求
3. CA 生成并签署服务器的证书，并且将该证书提供给 enclave。 enclave 检查证书的有效性。之后将证书持久化保存在不受信任的内存中，密封密钥对，然后触发TLS来更新服务器的证书。CA能够请求新的签名来更新服务器证书。

#### enclave 信任用户

CA 会验证用户的身份并提供客户端证书，证书中包含身份信息如 ID，邮件地址或者全名。在TLS期间，应用程序将客户端证书提交给 enclave，他使用CA的公钥来验证证书。

### 运行时：请求和响应

#### 用户应用程序

用户应用程序将用户的本地文件系统连接到云提供商的远程文件系统。通过SeGShare的外部接口建立与可信TLS借口的安全TLS连接。用户可以将请求发送到enclave中。在用户应用程序中只需要存储客户端证书和响应的私钥。

#### TLS 接口

所有的TLS记录都转发到受信任的TLS接口中，他使用服务端的证书进行握手，然后将所有传入或者传出的TLS记录进行加密或者解密。

#### 请求处理

请求处理组件解析每个传入的请求，使用客户端证书中的身份信息将请求分配给用户，

#### 访问控制组件

访问控制组件进行关系更新以及访问控制检查。使用文件管理器组件来读取和写入所需的关系。

#### 文件管理

受信任和不受信任的文件管理组件处理存储在不受信任的内存中的所有文件。受信任的文件管理组件使用每个文件唯一的密钥来来加密或解密使用PAE读或写的内容。

文件管理处理下列的文件类型：

* 常规文件
* ACL 文件来存储访问权限和文件所有者
* 组
* member list file

前两者存储在根据路径给出的字典中。后两者扁平化的存储，根路径存储所有的文件。这样能够增加一层安全性提高了性能因为文件，目录和权限操作是独立于组操作的。

ACL的内容，成员列表和组列表是排好序的。因此，权限更新只需要对相应的ACL进行一次解密，对数级别的搜索，一次插入或者更新操作然后对ACL进行一次加密。

membership 的更新对成员列表文件和组列表文件进行相同的操作。所以权限和memebership 的修改不需要对文件进行重新加密，而且可以立即执行它们。

## 扩展

### 重复数据删除

通过引入第三者存储，对于每个上传的文件，受信任的文件管理会处理下列步骤：

* 临时在重复删除存储中存放文件并给一个唯一的随机名称。
* 通过文件的内容计算HMAC值
* 转换HMAC为一个16进制的字符串hName
* 如果没有相同的hName在重复删除存储中，将文件重命名为hName，否则删除临时文件
* 将内容文件添加到内容存储中，并且将内容文件内容改为hName

### 单个文件回滚保护

使用Merkle哈希树来防止单个文件的回滚。每个内容文件，ACL均由Merkle树的叶子节点表示，而其他目录文件均由内部节点表示。每个叶子结点都存储一个哈希，由文件路径和文件内容上的哈希组成。每个内部节点存储一个哈希，是所有子代的哈希。

在加密之前，受信任的文件管理器会在内容文件，ACL和目录文件的内容中添加合并的哈希值，并在解密后从那里读取哈希值。树的根哈希存储在根目录文件中。

### 文件系统回滚保护

攻击者仍然能够回滚整个文件系统。

TEE提供只能由特定去余访问的受保护内存，并且在重新启动后仍然存在，将根哈希值写入该内存。

如果TEE提供的计数器只能由特定的去余访问，并且在重新启动后仍然存在，在每次文件更新时，受信任的文件管理器会递增计数器，并在加密之前将新的计数器值写入根文件中。在对根哈希进行有效性检查的时候，将TEE的计数器和根文件的计数器进行比较
